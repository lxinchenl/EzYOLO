# 标注页面优化路径

## 1. 项目现状分析

通过对当前标注页面实现的分析，发现以下问题和不足：

### 1.1 多边形标注问题
- **吸附效果缺失**：绘制多边形时，最后一个点难以形成封闭多边形，缺少对初始点的吸附效果
- **移动问题**：多边形标注移动不灵活，且移动距离明显超出鼠标移动距离

### 1.2 标注功能缺失
- **Pose标注**：仅在任务类型选择器中添加了选项，无实际标注功能实现
- **OBB标注**：仅在任务类型选择器中添加了选项，无实际标注功能实现

### 1.3 UI结构问题
- **标注工具固定**：工具栏中固定显示所有标注工具（矩形、多边形、移动），未根据任务类型动态调整
- **任务类型切换**：on_task_changed方法仅更新项目任务类型，未调整UI工具

### 1.4 功能适配问题
- **自动标注**：仅支持detect任务类型，硬编码任务类型为'detect'，只生成bbox类型标注
- **批量处理**：支持批量删除和修改标注类别，但未根据任务类型进行特定处理

## 2. 优化目标

1. **优化多边形标注体验**：添加初始点吸附效果，解决移动不灵活问题
2. **实现多任务标注功能**：
   - 完善segment任务的多边形标注
   - 实现pose任务的关键点标注
   - 实现obb任务的旋转矩形标注
3. **动态UI调整**：根据项目任务类别自动调整符合的标注工具
4. **多任务功能适配**：
   - 自动标注适配多任务类别
   - 批量处理适配多任务类别

## 3. 详细优化路径

### 3.1 多边形标注优化

#### 3.1.1 添加初始点吸附效果
- **修改文件**：`gui/pages/annotate_page.py`
- **修改位置**：`AnnotationCanvas`类的`mouseMoveEvent`方法
- **实现思路**：
  1. 在多边形绘制模式下，实时计算鼠标与初始点的距离
  2. 当距离小于阈值（如10像素）时，将鼠标位置吸附到初始点
  3. 显示视觉反馈（如初始点高亮）

#### 3.1.2 优化多边形移动
- **修改文件**：`gui/pages/annotate_page.py`
- **修改位置**：`AnnotationCanvas`类的`drag_annotation`方法
- **实现思路**：
  1. 检查坐标转换逻辑，确保正确处理图像缩放
  2. 优化鼠标移动距离计算，确保移动距离与鼠标移动一致
  3. 添加平滑移动效果，提高用户体验

### 3.2 Pose标注功能实现

#### 3.2.1 添加Pose标注工具
- **修改文件**：`gui/pages/annotate_page.py`
- **实现思路**：
  1. 在`AnnotationCanvas`类中添加`keypoint`标注类型支持
  2. 实现关键点绘制和编辑功能
  3. 在工具栏中添加Pose标注按钮（根据任务类型显示）

#### 3.2.2 关键点标注交互
- **修改文件**：`gui/pages/annotate_page.py`
- **实现思路**：
  1. 实现点击添加关键点的交互
  2. 支持关键点的选择和移动
  3. 支持关键点的删除

### 3.3 OBB标注功能实现

#### 3.3.1 添加OBB标注工具
- **修改文件**：`gui/pages/annotate_page.py`
- **实现思路**：
  1. 在`AnnotationCanvas`类中添加`obb`标注类型支持
  2. 实现旋转矩形绘制和编辑功能
  3. 在工具栏中添加OBB标注按钮（根据任务类型显示）

#### 3.3.2 旋转矩形标注交互
- **修改文件**：`gui/pages/annotate_page.py`
- **实现思路**：
  1. 实现拖拽创建旋转矩形的交互
  2. 支持旋转角度的调整
  3. 支持旋转矩形的移动和缩放

### 3.4 动态UI调整

#### 3.4.1 根据任务类型调整标注工具
- **修改文件**：`gui/pages/annotate_page.py`
- **修改位置**：`create_toolbar`方法和`on_task_changed`方法
- **实现思路**：
  1. 为每个任务类型定义对应的标注工具集合：
     - detect: 矩形工具
     - segment: 多边形工具
     - pose: 关键点工具
     - obb: 旋转矩形工具
     - classify: 无标注工具（或类别选择）
  2. 在`on_task_changed`方法中，根据当前任务类型动态显示/隐藏对应工具按钮
  3. 确保默认选中对应任务类型的主要工具

#### 3.4.2 统一标注按钮
- **修改文件**：`gui/pages/annotate_page.py`
- **实现思路**：
  1. 考虑将多个标注工具按钮整合为一个下拉菜单或动态切换的单一按钮
  2. 当切换任务类型时，自动更新按钮功能和显示

### 3.5 自动标注多任务支持

#### 3.5.1 修改模型加载逻辑
- **修改文件**：`core/auto_labeler.py`
- **修改位置**：`load_model`方法
- **实现思路**：
  1. 从配置中获取任务类型，不再硬编码为'detect'
  2. 根据任务类型加载对应的模型

#### 3.5.2 多任务标注生成
- **修改文件**：`core/auto_labeler.py`
- **修改位置**：`_generate_annotations`方法
- **实现思路**：
  1. 根据模型类型和推理结果生成对应任务类型的标注
  2. 支持segment任务的多边形标注生成
  3. 支持pose任务的关键点标注生成
  4. 支持obb任务的旋转矩形标注生成

### 3.6 批量处理多任务支持

#### 3.6.1 任务类型适配
- **修改文件**：`gui/pages/batch_process_dialog.py`
- **实现思路**：
  1. 根据当前项目任务类型调整批量处理选项
  2. 为不同任务类型提供特定的批量处理功能

#### 3.6.2 多类型标注处理
- **修改文件**：`gui/pages/annotate_page.py`
- **实现思路**：
  1. 在批量处理逻辑中，根据标注类型进行相应处理
  2. 确保支持对多边形、关键点、旋转矩形标注的批量操作

## 实施任务清单

### 多边形标注优化
- [x] 在多边形绘制模式下添加初始点吸附效果
- [x] 修复多边形移动不灵活的问题

### Pose标注功能实现
- [x] 添加keypoint标注类型支持
- [x] 实现关键点绘制和编辑功能
- [x] 在工具栏中添加Pose标注按钮
- [x] 实现点击添加关键点的交互
- [x] 支持关键点的选择和移动
- [x] 支持关键点的删除

### OBB标注功能实现
- [x] 添加obb标注类型支持
- [x] 实现旋转矩形绘制和编辑功能
- [x] 在工具栏中添加OBB标注按钮
- [x] 实现拖拽创建旋转矩形的交互
- [x] 支持旋转角度的调整
- [x] 支持旋转矩形的移动和缩放

### 动态UI调整
- [x] 为每个任务类型定义对应的标注工具集合
- [x] 在on_task_changed方法中根据任务类型动态显示/隐藏工具按钮
- [x] 确保默认选中对应任务类型的主要工具
- [ ] 考虑将多个标注工具按钮整合为下拉菜单或单一按钮

### 自动标注多任务支持
- [ ] 修改模型加载逻辑，从配置中获取任务类型
- [ ] 根据任务类型加载对应的模型
- [ ] 修改标注生成逻辑，根据模型类型生成对应任务类型的标注
- [ ] 支持segment任务的多边形标注生成
- [ ] 支持pose任务的关键点标注生成
- [ ] 支持obb任务的旋转矩形标注生成

### 批量处理多任务支持
- [ ] 根据当前项目任务类型调整批量处理选项
- [ ] 为不同任务类型提供特定的批量处理功能
- [ ] 在批量处理逻辑中根据标注类型进行相应处理
- [ ] 确保支持对多边形、关键点、旋转矩形标注的批量操作

### 测试与优化
- [ ] 功能测试：验证所有任务类型的标注功能
- [ ] 性能优化：确保标注操作流畅
- [ ] 用户体验调整：优化交互细节
- [ ] 兼容性测试：确保不影响现有detect任务功能